#!/bin/sh
# DdShurick GPL v005 20.01.15 for Richy
[ "$(whoami)" = "root" ] || exec loginroot $0

eval $(egrep 'PSUBDIR|PDEV1' /etc/rc.d/PUPSTATE)
IFDIR=/mnt/${PDEV1}${PSUBDIR}

if [ "$(grep $PDEV1 /proc/mounts)" = "" ]; then
mkdir /mnt/$PDEV1
mount /dev/$PDEV1 /mnt/$PDEV1
umnt=1
fi

mkdir -p /temp
mount -t tmpfs tmpfs /temp
[ "$(grep 'pup_ro1 ' /proc/mounts)" ] && cp -a /initrd/pup_ro1/* /temp/
cp -a /initrd/pup_rw/[!dimstv]* /temp/
echo false > /temp/etc/.XLOADED
[ -f $IFDIR/base/Richy-save.sfs ] && mv -f $IFDIR/base/Richy-save.sfs $IFDIR/base/Richy-save-old.sfs
mksquashfs /temp/ $IFDIR/base/Richy-save.sfs -comp xz
rm -r /temp/*
rmdir /temp
[ "$umnt" = 1 ] && (umount /mnt/$PDEV1; rmdir /mnt/$PDEV1)
xpupsay "Сохранено"
