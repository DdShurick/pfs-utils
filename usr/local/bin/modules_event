#!/bin/sh
#DdShurick 12.01.15 GPL v2 modifited for Richy and PRA

if [ -f /var/log/*-livedbg ]; then
 eval $(grep -n -m 2 mnt /var/log/*-livedbg | sed 's/1:/IFDEV=/;s/2:/IFDIR=/')
 REPO="http://mirror.yandex.ru/puppyrus/puppyrus-a/pra02/pfs/"
elif [ -f /etc/rc.d/PUPSTATE ]; then
 eval $(egrep 'PSUBDIR|PDEV1' /etc/rc.d/PUPSTATE)
 IFDIR=/mnt/${PDEV1}${PSUBDIR}
 REPO="http://mirror.yandex.ru/puppyrus/puppyrus/repository/"
else
 exit 1
fi

LIST=$(sudo busybox losetup | awk '!/^[0-9][0-9]|\-base|\-save|kernel/ {print $3}')
GREP=$(for M in $LIST; do basename $M | tr '\n' '|'; done)

if [ ! $(grep $PDEV1 /proc/mounts) ]; then 
mkdir -p /mnt/$PDEV1
sudo mount /dev/$PDEV1 /mnt/$PDEV1
UMNT=1
fi

OFFLIST=$(ls -1 $IFDIR/modules $IFDIR/optional | egrep -v "${GREP}^/mnt|^$")

export Window="<hbox>
 <vbox>
  <text><label>Подключенные модули</label></text>
  <list>
   <variable>OFF_MODULE</variable>
   $(for M in $LIST; do basename $M | sed 's/^/<item>/;s/$/<\/item>/'; done)
  </list>
  <hbox>
  <button><label>Отключить</label></button>
  </hbox>
 </vbox>
 <vbox>
  <text><label>Неподключенные модули</label></text>
  <list>
   <variable>ON_MODULE</variable>
   $(for OFF in $OFFLIST; do echo $OFF | sed 's/^/<item>/;s/$/<\/item>/'; done)
  </list>
  <hbox>
  <button><label>Подключить</label></button>
  <button><label>Скачать</label></button>
  <button cancel></button>
  </hbox>
 </vbox>
</hbox>"
eval $(gtkdialog3 -c --program "Window" --geometry 450x400)

[ "$EXIT" = "Cancel" -o  "$EXIT" = "abort" ] && exit
if [  "$EXIT" = "Подключить"  ]; then
[ "$ON_MODULE" ] || exit
load_sfs $(find $IFDIR/ -name $ON_MODULE)
fi
if [  "$EXIT" = "Отключить"  ]; then
[ "$OFF_MODULE" ] || exit
unload_sfs $(echo "$LIST" | grep $OFF_MODULE)
fi
if [ "$EXIT" = "Скачать" ]; then
curl $REPO | awk -F [\<\>] '/\.pfs/ {print "<item>"$3" "$5"</item>"}' > /tmp/repolist
export Repo="<vbox>
  <text><label>Репозиторий модулей</label></text>
  <list>
   <variable>GET_MODULE</variable>
   $(cat /tmp/repolist)
  </list>
  <hbox>
  <button><label>Скачать</label></button>
  <button cancel></button>
  </hbox>
 </vbox>"
eval $(gtkdialog3 -c --program "Repo" --geometry 520x450)

[ "$EXIT" = "Cancel" -o  "$EXIT" = "abort" -o "$GET_MODULE" = "" ] && exit
GET_MODULE=$(echo $GET_MODULE | cut -f1 -d' ')
curl ${REPO}${GET_MODULE} > $IFDIR/optional/$GET_MODULE
fi
[ "$UMNT" = 1 ] && sudo umount /mnt/$PDEV1 && sudo rmdir /mnt/$PDEV1
