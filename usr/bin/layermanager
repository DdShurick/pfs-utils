#!/bin/sh
#layermanager: to connect the module to the layer aufs. GPL v2, DdShurick, 17.01.2017.

usage () {
	echo "Usage:"
	echo "	 PROGNAME [key] modulename"
	echo "keys:"
	echo "	 -d|--delete|--del - to delete the module from the layer"
	echo "	 -h|--help - this usage"
	echo "	 -i|--install - to install the module in / as the package"
	echo "	 -n - not to execute the commands depmod and ldconfig after connecting"
	echo "	 -s|--show - show all layers == showlayers"
	echo "	 -u N|--uplevel N - to connect the module to the layer N"
	echo "	 -v|--verbose"
	exit 0
}

check_status() {
	echo -en "\\033[72G"
	if [ $1 -eq 0 ]; then
		echo -en "\\033[1;32mOK"
		echo -e "\\033[0;39m"
	else
		echo -en "\\033[1;31mError"
		echo -e "\\033[0;39m"
		echo $2
		exit 1
	fi
}

err() {
	if [ "$1" != 0 ]; then
		echo $2 
		exit $1
	fi
}

showlayers() {
	##developer sfs
	echo "Слои AUFS (the top layer covers anything below)" #верхний слой перекрывает все что ниже
	printf %3s "N "; printf %-51s Модуль; printf "Путь\n\n"
	n=0
	while true; do 
    	BR="`cat /sys/fs/aufs/si_*/br$n 2>/dev/null`" && printf %3s "$n " && printf %-45s `basename $BR` && echo `dirname $BR` || break
    	n=$(expr $n + 1)
	done
	exit 0
}

modulemount() {
	[ $CMT ] && echo -n "mount $MODNAME"
	$SUDO mkdir -p /$SYSMNT/bundles/$MODNAME
	$SUDO mount -o loop $MOD /$SYSMNT/bundles/$MODNAME
	$SUDO mount -o remount,$MNTCMD:/$SYSMNT/bundles/$MODNAME/=ro /
	check_status $?
}

moduleinstall() {
	[ $CMT ] && echo -n 
	$SUDO mkdir -p /mnt/data
	$SUDO mount -o loop $MOD /mnt/data
	$SUDO cp -a /mnt/data/* /
	$SUDO umount /mnt/data
	check_status $?
}

[ "$(id -u)" = 0 ] || SUDO=sudo
PROGNAME=`basename $0`
[ "$PROGNAME" = "layermanager" ] || $PROGNAME #
[ $1 ] || usage
CS="err"
MNTCMD=append 
[ "$(readlink /sbin/losetup)" = '../bin/busybox' ] && FREELOOP=$(/sbin/losetup -f | tr -d [a-z/]) || FREELOOP=$(/sbin/losetup -a | tail -n1 | cut -b 10-11)
#FREELOOP=$(/sbin/losetup -f | cut -b10-)

O=$(getopt -l delete,del,debug,help,install,show,verbose,uplevel: -- Ddhinsvu: $@) || usage
eval set -- "$O"
for OPT in $O
do
	case "$OPT" in
	-d|--delete|--del) DELCMD=del; shift;;
	-h|--help) usage; break;;
	-i|--install) CMD="$SUDO unsquashfs -f -d /"; shift;;
	-n) LD=no; shift;;
	-s|--show) showlayers; break;;
	-u|--uplevel)
		if [ "$FREELOOP" -gt "$2" ]; then
	 		MNTCMD=add:$2; shift 2
	 	else
	 		$CS 1 "Invalid -u key" 
	 	shift; fi
	 ;;
	 -v|--verbose) CS="check_status"; CMT="ok"; shift;;
	--)	shift; break;;
	esac
done

[ "$CMD" ] && MNTCMD=""
[ "$SYSMNT" ] || SYSMNT=$(cut -f2 -d/ /sys/fs/aufs/si_*/br0)

[ $CMT ] && echo -n "Find module, "
MOD=$(realpath $1) && $CS 0 || $CS 1 "No file $1"
MODNAME=$(basename $MOD)
[ $CMT ] && echo -n "Check free loop, "
[ "$(/sbin/losetup -f)" ]; $CS $?

[ $CMT ] && echo -n "Check module: "
if [ "$(file -b $MOD | grep 'Squashfs filesystem')" ]; then
	[ $CMT ] && echo -n "Squashfs "
	if [ "$(file -b $MOD | grep 'version 4.0')" = "" ]; then
		MSGERR="$MOD старая версия squashfs. Перепакуйте."
	else
		[ $CMT ] && echo -n "version 4.0"
		[ "$CMD" ] && $CMD $MOD #CMD="$CMD $MOD"
		[ "$MNTCMD" ] && modulemount #MNTCMD="mkdir -p /$SYSMNT/bundles/$MODNAME && mount -o loop $MOD /$SYSMNT/bundles/$MODNAME && mount -o remount,$MNTCMD:/$SYSMNT/bundles/$MODNAME/ /"
	fi
elif [ "$(file -b $MOD | grep 'Linux rev 1.0 ext')" ]; then
	[ $CMT ] && echo -n "$MODNAME is file ext filesystem"
	[ "$CMD" ] && moduleinstall #CMD="mount -o loop $MOD /mnt/data && cp -a /mnt/data/* / && umount /mnt/data"
	[ "$MNTCMD" ] && modulemount #MNTCMD="mkdir -p /$SYSMNT/bundles/$MODNAME && mount -o loop $MOD /$SYSMNT/bundles/$MODNAME && mount -o remount,$MNTCMD:/$SYSMNT/bundles/$MODNAME/ /"
elif [ "$(file -b $MOD | grep 'directory')" ]; then
	[ $CMT ] && echo -n "$MODNAME is directory"
	[ "$CMD" ] && $SUDO cp -a $MOD/* / #CMD="cp -a $MOD/* /"
	[ "$MNTCMD" ] && $SUDO mount -o remount,$MNTCMD:/$SYSMNT/bundles/$MODNAME/ /
else
	$CS 1 "invalid $MODNAME"
fi
$CS 0
[ $CMT ] && exit 0
echo ""
echo "Отчёт:"
[ "$MNTCMD" ] && echo "Подключен $MODNAME точка монтирования /$SYSMNT/bundles/$MODNAME"
[ "$CMD" ] && echo "Установлен $MODNAME"
[ "$LD" ] && echo "depmod and ldconfig $LD"
$CS 0
