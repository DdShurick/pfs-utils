#!/bin/sh
## addlayer, DdShurick 16.02.2017, GPL v2.

usage () {
	if [ "$1" ]; then
		echo "$0: $1"
		exit 1
	fi
	echo "Использовать: addlayer [0-9] module"
#	echo ""
	echo "Модуль может быть squashfs, файл с внутренней ФС ext и каталог."
	exit 0
}

[ "$1" = "" -o "$1" = "-h" -o "$1" = "--help" ] && usage
[ "$(id -u)" = 0 ] || usage "Разрешено только root"
SYSMNT=$(cut -f2 -d/ /sys/fs/aufs/si_*/br0 | head -n1)

case "$1" in
	0) AUFSMNT="/"; shift;;
	[1-9]) N=$1
		if [ $N -lt $(ls -d /sys/fs/aufs/si_* | wc -w) ]; then
			AUFSMNT=/$SYSMNT/aufs$N
			shift
		else
			usage "aufs с таким № нет"
		fi
	;;
	*) AUFSMNT="/" ;;
esac

NEWLAYER=$(realpath "$1") || usage "Файл не найден"
[ "$(grep aufs$N /proc/mounts)" ] || usage "aufs с таким № не существует"
MODNAME=$(basename "$NEWLAYER")
#for SI in $(ls /sys/fs/aufs/si_*)
#	do
#		grep changes$N /sys/fs/aufs/$SI/br0 >/dev/null || continue
#	done
#	
#[ "$SI" ] || usage "aufs с таким № не существует"

case $(file -b $NEWLAYER) in
	*directory) MODTYPE="dir" ;;
	Squashfs*4.0*|Linux*ext*) MODTYPE="sfs"
		mkdir -p /$SYSMNT/bundles$N/"$MODNAME"
		mount -o loop "$NEWLAYER" /$SYSMNT/bundles$N/"$MODNAME"
		NEWLAYER=/$SYSMNT/bundles$N/"$MODNAME"
	;;
	"") usage "Missing modulename" ;;
	*) usage "Invalid format $MODNAME" ;;
esac

mount -o remount,add:1:"$NEWLAYER" $AUFSMNT || usage "Ошибка монтирования"

[ "$AUFSMNT" = "/" ] || echo "aufs смонтирована в $AUFSMNT, сохранение изменений /$SYSMNT/changes$N"
